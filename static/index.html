<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8" />
    <title></title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  </head>
  <body>
    <div id="chart"></div>

    <script>
      let lastTs = 0;

      (async () => {
        let rsp = await fetch("/data");
        let data = await rsp.json();
        let humid = data.map(v => [v.ts, v.humid]);
        let temp = data.map(v => [v.ts, v.temp]);

        lastTs = (new Date(data[data.length-1])).getTime();
        chart(temp, humid);
      })();
      
      function chart(temp, humid){
        var options = {
          series: [
            {
              name: "Temperature",
              data: temp,
            },
            {
              name: "Humidity",
              data: humid,
            },
          ],
          chart: {
            type: "area",
            stacked: false,
            height: 350,
            zoom: {
              type: "x",
              enabled: true,
              autoScaleYaxis: true,
            },
            toolbar: {
              autoSelected: "zoom",
            },
          },
          dataLabels: {
            enabled: false,
          },
          markers: {
            size: 0,
          },
          title: {
            text: "Temperature / Humidity data",
            align: "left",
          },
          fill: {
            type: "gradient",
            gradient: {
              shadeIntensity: 1,
              inverseColors: false,
              opacityFrom: 0.5,
              opacityTo: 0,
              stops: [0, 90, 100],
            },
          },
          yaxis: {
            labels: {
              formatter: function (val) {
                return val.toFixed(2);
              },
            },
            title: {
              text: "Value",
            },
          },
          xaxis: {
            type: "datetime",
            labels: {
              formatter: function (value, timestamp) {
                return (new Date(timestamp)).toLocaleString()
              }, 
            }
          },
          tooltip: {
            shared: false,
            y: {
              formatter: function (val) {
                return val.toFixed(2);
              },
            },
          },
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        /*
        window.setInterval(async () => {
          let rsp = await fetch("/data");
          let data = await rsp.json();
          let humid = data.map(v => [v.ts, v.humid]);
          let temp = data.map(v => [v.ts, v.temp]);
        
          humid = humid.filter(v => (new Date(v[0])).getTime() > lastTs);
          temp = temp.filter(v => (new Date(v[0])).getTime() > lastTs);

          if(humid.length !== 0){
            chart.appendData([
              {
                data: temp,
              },
              {
                data: humid,
              },
            ])

            lastTs = (new Date(humid[humid.length-1][0])).getTime();
          }
        }, 1000)
        */
      }
    </script>
  </body>
</html>
